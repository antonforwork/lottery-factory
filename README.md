# Lottery Factory

- В контракте создаются игры/лотереи каждые N часов. 
- Игрок может купить токены за эфир. Стоимость токенов растет каждые N минут по заранее известной шкале.
- Токены можно продать другим игрокам по текущей цене. То есть в любой момент можно выставить купленные токены на продажу. При этом если кто-то хочет их купить, то он сначала выкупает их у других игроков, а только потом у системы (если предложений от игроков нет)
- По окончанию N часов определяется победитель(с наибольшим кол-вом токенов), который получает весь оставшийся банк эфира

## Public methods

##### approveToSell(uint _tokenCount)
Выставить _tokenCount токенов на продажу. 

##### balanceOf(address _user)
Возвращает баланс игрока в токенах.

##### buyTokens()
Покупает токены. Если текущая цена за 1 токен = 0.1 eth, то отправив 0.3 eth, игрок купит 3 токена. Сначала выкупаются токены, которые висят на продаже, затем токены у системы. Если на продаже висит 10 токен, а игрок хочет купить 15, то 10 токено приоберутся у продавцов, а 5 будут докуплены у системы.

##### disapproveToSell(uint _tokenCount)
Снять _tokenCount токенов с продажи.

##### getLotteryAtIndex(uint _index)
Возвращает информацию о лотерее по ее индексу. Вернет массив с параметрами: timestamp создания, общее кол-во выпущенных токенов, общее кол-во токенов на продаже, выигрыш победителя, победитель.

##### function updateParams( uint _gameDuration, uint _initialTokenPrice, uint _durationToTokenPriceUp, uint _tokenPriceIncreasePercent, uint _tradeCommission, uint _winnerCommission )
Обновление параметров лотереи. Параметры будут применены при создании следующей лотереи.
_gameDuration - длина 1 игры в секундах
_initialTokenPrice - начальная цена за 1 токен в wei
_durationToTokenPriceUp - время в секундах, после которого цена за 1 токен повышается
_tokenPriceIncreasePercent - на сколько % повышается цена за 1 токен на каждом шаге
_tradeCommission - комиссия системы в % при покупке игроком токена у другого игрока
_winnerCommission - комиссия системы в % при переводе выигрыша игрока

##### withdraw()
Перевод суммы всех комиссий на адрес создателя контракта.

##### withdrawForWinner(uint _lotteryIndex)
Метод может вызвать только победитель лотереи с индексом _lotteryIndex. Переводит выигрыш победителю.

## Как загрузить в реальную или тестовую сеть
1. скопировать этот репозиторий
2. `npm i truffle -g`
3. в корне проекта создать файл `.env` со следующим содержимым:
```
MNEMONIC="YOUR_MNEMONIC"
INFURA_API_KEY="YOUR_INFURA_API_KEY"
```
где: 
`MNEONIC` - фраза из 12 слов для генерации ваших приватных ключей. Можно найти в настройках MetaMask
`INFURA_API_KEY` - api ключ infura. Нужно зарегистрироваться на https://infura.io и получит в личном кабинете ключ
4. Деплой осуществляется с 1го кошелька, который генерируется из `MNEMONIC`. Убедитесь, что на нем есть средства. Деплой в различные сети: 
```
// main net
truffle migrate --network main
// test networks
truffle migrate --network ropsten
truffle migrate --network kovan
truffle migrate --network rinkeby
```

## Особенности
- при равенстве кол-ва токенов победителем признается тот, кто раньше их купил. То есть если user1 купил 10 токенов, а через час user2 купил столько же, то победителем будет user1.
- цена за 1 токен увеличивается за каждый шаг на одну и ту же сумму. То есть если начальная цена за 1 токен 1 eth и прирост за шаг 10%, то каждые 15 мин цена токена будет увеличиваться на 0.1 eth.
- насчет автоматического создания игр. В ethereum нет такого, чтобы установить таймер и следить за наступлением определенного события. В нашем случае нужно по истечению 6 часов создавать новую игру. Аукционы создаются в момент покупки токенов. То есть если аукцион начался в 0:00 и закончился в 06:00, а сейчас 07:00 и user1 покупает 1 токен, то только в этот момент аукцион будет создан, хотя время начала у него будет 06:00:01. В интерфейсе придется высчитывать в каком временном промежутке сейчас идет игра. То есть на фронтенде нужно будет получить время начала последней игры и рассчитать текущий временной интервал.